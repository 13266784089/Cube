var request=require("superagent"),async=require("async"),crypto=require("./Crypto"),fm=require("./FileManager"),PltM=require("./PlaylistModel"),SongM=require("./SongModel"),header={Accept:"*/*","Accept-Encoding":"gzip,deflate,sdch","Accept-Language":"zh-CN,en-US;q=0.7,en;q=0.3",Connection:"keep-alive","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Host:"music.163.com",Referer:"http://music.163.com/","User-Agent":"Mozilla/5.0 (X11; Linux x86_64; rv:39.0) Gecko/20100101 Firefox/39.0"},httpRequest=function(t,e,r,i){var o;o="post"==t?request.post(e).send(r):request.get(e).query(r);var n=fm.getCookie();n&&o.set("Cookie",n),o.set(header).timeout(1e4).end(i)};module.exports={login:function(t,e,r){var i,o,n=/^0\d{2,3}\d{7,8}$|^1[34578]\d{9}$/;n.test(t)?(o="phone",i="http://music.163.com/weapi/login/cellphone/"):(o="username",i="http://music.163.com/weapi/login/"),e=crypto.MD5(e);var s={};s[o]=t,s.password=e,s.rememberLogin="true";var a=crypto.aesRsaEncrypt(JSON.stringify(s)),c={params:a.encText,encSecKey:a.encSecKey};httpRequest("post",i,c,function(t,e){if(t)return void r({msg:"[login]http error "+t,type:1});var i=JSON.parse(e.text);200!=i.code?r({msg:"[login]username or password incorrect",type:0}):(fm.setCookie(e.header["set-cookie"]),r(null,i.profile))})},getNet:function(t){var e=this;this.userPlaylist(function(r,i){return r?void t(r):void async.map(i,function(t,r){e.playlistDetail(t.id,function(e,i){if(e)return void r(e);var o=new PltM({name:t.name,type:"net",songList:i});r(null,o)})},function(e,r){e?t(e):t(null,r)})})},userProfile:function(t,e){if(t=t||fm.getUserID()){var r="http://music.163.com/api/user/detail/"+t;httpRequest("get",r,{userId:t},function(t,r){t?e({msg:"[userProfile]http error "+t,type:1}):200!=r.body.code?e({msg:"[userProfile]http code "+r.body.code,type:1}):e(null,r.body.profile)})}else e({msg:"[userProfile]user not login",type:0})},userPlaylist:function(){var t=[].slice.call(arguments),e=t.pop(),r=fm.getUserID();if(!r)return void e({msg:"[userPlaylist]user do not login",type:0});var r=t[0]||r,i=t[1]||0,o=t[2]||100,n="http://music.163.com/api/user/playlist/",s={offset:i,limit:o,uid:r};httpRequest("get",n,s,function(t,r){return t?void e({msg:"[userPlaylist]http timeout",type:1}):void(200!=r.body.code?e({msg:"[userPlaylist]http code "+s.code,type:1}):e(null,r.body.playlist))})},playlistDetail:function(t,e){var r="http://music.163.com/api/playlist/detail",i={id:t},o=this;httpRequest("get",r,i,function(t,r){t?e({msg:"[playlistDetail]http timeout",type:1}):200!=r.body.code?e({msg:"[playlistDetail]http code "+i.code,type:1}):e(null,o.transfer(r.body.result.tracks))})},search:function(){var t=[].slice.call(arguments),e=t.pop(),r=t[0],i=t[1]||1,o=t[2]||0,n=t[3]||"true",s=t[4]||fm.getSearchLimit(),a="http://music.163.com/api/search/get/web",c={s:r,type:i,offset:o,total:n,limit:s},l=this;httpRequest("post",a,c,function(t,r){if(t)return void e({msg:"[search]http error "+t,type:1});var i=JSON.parse(r.text);if(200!=i.code)e({msg:"[search]http code "+i.code,type:1});else{var o=i.result.songs,n=l.transfer(o);e(null,n)}})},transfer:function(t){for(var e=[],r=[],i={},o=0;o<t.length;o++){var n=t[o];r.push(n.id),i[n.id]=o;var s={src:""};s.id=n.id,s.title=n.name,s.album=n.album.name,s.artist=n.artists.map(function(t){return t.name}).join(),e.push(new SongM(s))}var a=this;return process.nextTick(function(){for(var t=Math.ceil(r.length/100),o=0;t>o;o++){var n=r.slice(100*o,Math.min(100*(o+1),r.length));a.songsDetail(n,function(t,r){if(t)throw t.msg;for(var o=0;o<r.length;o++){var n=i[r[o].id];e[n].src=r[o].mp3Url,e[n].pic=r[o].album.picUrl}})}}),e},songsDetail:function(t,e){var r="http://music.163.com/api/song/detail";httpRequest("get",r,{ids:"["+t.join()+"]"},function(t,r){if(t)return void e({msg:"[songsDetail]http error "+t,type:1});var i=JSON.parse(r.text);200!=i.code?e({msg:"[songsDetail]http code "+i.code,type:1}):e(null,i.songs)})},songDetail:function(t,e){var r="http://music.163.com/api/song/detail";httpRequest("get",r,{id:t,ids:"["+t+"]"},function(t,r){if(t)return void e({msg:"[songDetail]http error "+t,type:1});var i=JSON.parse(r.text);200!=i.code?e({msg:"[songDetail]http code "+i.code,type:1}):e(null,i)})},songLyric:function(t,e){var r="http://music.163.com/api/song/lyric";httpRequest("get",r,{os:"android",id:t,lv:-1,tv:-1},function(t,r){if(t)return void e({msg:"[songLyric]http error "+t,type:1});var i=JSON.parse(r.text);i.lrc?e(null,i.lrc.lyric):e({msg:"[songLyric]lrc do not exist",type:0})})},radio:function(t){var e="http://music.163.com/api/radio/get";httpRequest("get",e,null,function(e,r){if(e)return void t({msg:"[radio]http error "+e,type:1});var i=JSON.parse(r.text);200!=i.code?t({msg:"[radio]http code "+i.code,type:1}):t(null,i.data.map(function(t){return new SongM({id:t.id,src:t.mp3Url,pic:t.album.picUrl,artist:t.artists.map(function(t){return t.name}).join(),album:t.album.name,title:t.name})}))})}};